---
title: "Full Stack Web App Built with Next.js App Router and PostgreSQL"
date: "2025-07-03T10:00:00Z"
summary: "Project structure of a full-stack Next.js web app with explanations of folders and files and some issues I encountered and how I solved them."
tags: ["software-development"]
---

Since my experience in front-end development is mostly with React, I recently built a full-stack movie app using the Next.js App Router
and PostgreSQL to get more comfortable with these technologies. The app supports searching, adding, editing, and
deleting movies, as well as authentication. It’s open source.

This post is a companion to the source code and gives an overview of the project structure along with explanations of files and directories using a tree UI component.
I also share some issues I faced and how I overcame them.

It’s assumed that you have a basic familiarity with the Next.js App Router.

_movie-app project structure:_

<TreeWithDescriptions
  data={[
    {
      isFolder: true,
      title: "app",
      key: "src/app",
      description: `This is the Next.js app directory. The Next.js app directory is essentially a routing system that uses folders and special files (e.g. page.tsx) to define routes. It also supports layouts which is basically a UI that is shared between multiple pages.`,
      children: [
        {
          isFolder: true,
          title: "(main)",
          key: "src/app/(main)",
          description: `Contains most application pages. As a route group (indicated by parentheses), it helps organize routes without affecting the URL structure.`,
          children: [
            {
              isFolder: true,
              title: "add-movie",
              key: "src/app/(main)/add-movie",
              children: [
                {
                  isFolder: false,
                  title: "page.tsx",
                  key: "src/app/(main)/add-movie/page.tsx",
                  description: "Page which contains form for adding a movie.",
                },
              ],
            },
            {
              isFolder: true,
              title: "edit-movie",
              key: "src/app/(main)/edit-movie",
              children: [
                {
                  isFolder: true,
                  title: "[id]",
                  key: "src/app/(main)/edit-movie/[id]",
                  description: "Dynamic route for editing a movie by ID.",
                  children: [
                    {
                      isFolder: false,
                      title: "page.tsx",
                      key: "src/app/(main)/edit-movie/[id]/page.tsx",
                      description: "Loads movie data by ID and renders page for editing a movie.",
                    },
                  ],
                },
              ],
            },
            {
              isFolder: true,
              title: "search",
              key: "src/app/(main)/search",
              children: [
                {
                  isFolder: false,
                  title: "page.tsx",
                  key: "src/app/(main)/search/page.tsx",
                  description: "Displays a page with search form and paginated movie results.",
                },
              ],
            },
            {
              isFolder: false,
              title: "layout.tsx",
              key: "src/app/(main)/layout.tsx",
              description: `Layout for the (main) route group. Applies to all routes inside the group but not outside it.`,
            },
            {
              isFolder: false,
              title: "page.tsx",
              key: "src/app/(main)/page.tsx",
              description: "Home page with a welcome message.",
            },
          ],
        },
        {
          isFolder: true,
          title: "api",
          key: "src/app/api",
          description: "API route handlers",
          children: [
            {
              isFolder: true,
              title: "genres",
              key: "src/app/api/genres",
              children: [
                {
                  isFolder: false,
                  title: "route.ts",
                  key: "src/app/api/genres/route.ts",
                  description: "Returns a list of genres from the database.",
                },
              ],
            },
            {
              isFolder: true,
              title: "seed",
              key: "src/app/api/seed",
              children: [
                {
                  isFolder: false,
                  title: "route.ts",
                  key: "src/app/api/seed/route.ts",
                  description: "Seeds genres, movies, and users tables in the database.",
                },
              ],
            },
            {
              isFolder: true,
              title: "session",
              key: "src/app/api/session",
              children: [
                {
                  isFolder: false,
                  title: "route.ts",
                  key: "src/app/api/session/route.ts",
                  description: "Returns session authentication status.",
                },
              ],
            },
          ],
        },
        {
          isFolder: true,
          title: "login",
          key: "src/app/login",
          children: [
            {
              isFolder: false,
              title: "page.tsx",
              key: "src/app/login/page.tsx",
              description: "Login page, a client component.",
            },
          ],
        },
        {
          isFolder: false,
          title: "favicon.ico",
          key: "src/app/favicon.ico",
          description: "Favicon for the application.",
        },
        {
          isFolder: false,
          title: "globals.css",
          key: "src/app/globals.css",
          description: "Global CSS styles and Tailwind customizations.",
        },
        {
          isFolder: false,
          title: "layout.tsx",
          key: "src/app/layout.tsx",
          description: "Root layout for the app, sets up providers and global styles.",
        },
      ],
    },
    {
      isFolder: true,
      title: "components",
      key: "src/components",
      description:
        "Inside this folder, components using client-specific features (e.g. state, effects) go in the client folder. Those using server-specific features (e.g. async components) go in the server folder. Components that use neither can technically work in both contexts (for example if they're imported by a client component, they'll automatically become part of the client bundle) -  so they are placed outside of these folders.",
      children: [
        {
          isFolder: true,
          title: "client",
          key: "src/components/client",
          description: "React client components. ",
          children: [
            {
              isFolder: false,
              title: "auth-provider.tsx",
              key: "src/components/client/auth-provider.tsx",
              description: "Context provider for authentication state and logic.",
            },
            {
              isFolder: false,
              title: "button-link.tsx",
              key: "src/components/client/button-link.tsx",
              description: "Link component styled to look like a button.",
            },
            {
              isFolder: false,
              title: "button.tsx",
              key: "src/components/client/button.tsx",
              description: "Reusable button component with style variants.",
            },
            {
              isFolder: false,
              title: "delete-button.tsx",
              key: "src/components/client/delete-button.tsx",
              description: "Button for deleting a movie, with confirmation and loading overlay.",
            },
            {
              isFolder: false,
              title: "header.tsx",
              key: "src/components/client/header.tsx",
              description: "App header with sidebar toggle and theme switch.",
            },
            {
              isFolder: false,
              title: "pagination.tsx",
              key: "src/components/client/pagination.tsx",
              description: "Pagination controls for navigating movie pages.",
            },
            {
              isFolder: false,
              title: "providers.tsx",
              key: "src/components/client/providers.tsx",
              description: "Wraps the app with authentication and theme providers.",
            },
            {
              isFolder: false,
              title: "search-form.tsx",
              key: "src/components/client/search-form.tsx",
              description: "Form for searching movies with filters.",
            },
            {
              isFolder: false,
              title: "sidebar.tsx",
              key: "src/components/client/sidebar.tsx",
              description: "Sidebar with navigation links and login/logout options.",
            },
            {
              isFolder: false,
              title: "theme-toggle.tsx",
              key: "src/components/client/theme-toggle.tsx",
              description: "Toggle switch for light/dark theme.",
            },
            {
              isFolder: false,
              title: "overlay.tsx",
              key: "src/components/client/overlay.tsx",
              description: "Full-screen overlay. Can show also loading spinner.",
            },
          ],
        },
        {
          isFolder: true,
          title: "server",
          key: "src/components/server",
          description: "React server components",
          children: [
            {
              isFolder: false,
              title: "paginated-movies-list.tsx",
              key: "src/components/server/paginated-movies-list.tsx",
              description: "Fetches and displays paginated movie results.",
            },
          ],
        },
        {
          isFolder: false,
          title: "loading.tsx",
          key: "src/components/loading.tsx",
          description: "Simple loading spinner component.",
        },
        {
          isFolder: false,
          title: "movies-list.tsx",
          key: "src/components/movies-list.tsx",
          description: "Displays a table of movies with actions.",
        },
      ],
    },
    {
      isFolder: true,
      title: "hooks",
      key: "src/hooks",
      description: "Custom React hooks.",
      children: [
        {
          isFolder: false,
          title: "useOptions.ts",
          key: "src/hooks/useOptions.ts",
          description: "Hook to fetch selectable options (e.g., genres) from API.",
        },
      ],
    },
    {
      isFolder: true,
      title: "lib",
      key: "src/lib",
      description: "Folder for some server-side logic.",
      children: [
        {
          isFolder: false,
          title: "auth.ts",
          key: "src/lib/auth.ts",
          description: "JWT signing/verification utilities and session token retriever.",
        },
        {
          isFolder: false,
          title: "movies.ts",
          key: "src/lib/movies.ts",
          description: `Methods for searching movies. These are not server functions because it is not recommended to use server functions for data fetching; moreover
we don't use these methods in the client components, which is usually the reason to use server functions.`,
        },
      ],
    },
    {
      isFolder: true,
      title: "server-functions",
      key: "src/server-functions",
      description: `Server functions allow client components to call asynchronous functions that are executed on the server. When that function is called on the client, React will send a request to the server to execute the function, and return the result. They are used for updating data. `,
      children: [
        {
          isFolder: false,
          title: "auth.tsx",
          key: "src/server-functions/auth.tsx",
          description: "Implements login and logout server functions.",
        },
        {
          isFolder: false,
          title: "movies.tsx",
          key: "src/server-functions/movies.tsx",
          description: "Implements server functions to add, edit, and delete movies.",
        },
      ],
    },
    {
      isFolder: true,
      title: "types",
      key: "src/types",
      description: `TypeScript type definitions.`,
      children: [
        {
          isFolder: false,
          title: "globals.d.ts",
          key: "src/types/globals.d.ts",
          description: "Global TypeScript definitions for project-wide types without the need for explicit imports.",
        },
      ],
    },
    {
      isFolder: false,
      title: "middleware.ts",
      key: "src/middleware.ts",
      description: "Middleware for protecting routes based on authentication.",
    },
    {
      isFolder: false,
      title: "utils.ts",
      key: "src/utils.ts",
      description: "Shared utilities for server and client.",
    },
  ]}
/>

## Notes

### Redirect From Middleware Not Working Properly With Server Functions

During working on this project I encountered one problem.
Currently even Nextjs docs mention that you can perform auth checks
inside middleware (though they mention this should _not be your only line_ of defense).
So you often encounter code like this inside middleware:

```
if (isProtectedRoute && !session) {
  return NextResponse.redirect(new URL('/login', req.nextUrl))
}
```

This works most of the time but there was one situation where it was causing a problem.

Suppose we are on a protected page and the session expires.
If then I invoked a server function from that page:

```
startTransition(async () => {
  // Call a server function
  const result = await addMovie(data);
  // ...
});
```

the `addMovie` call triggered the middleware. Because we are on a protected page and the session had expired,
the middleware attempted to redirect using `NextResponse.redirect` (as shown in the previous `if` check).
However apparently since the middleware was called due to server function, the redirect didn't
happen. The `addMovie` function itself never ran and simply returned `undefined`.

It seems others have also encountered this issue, so my solution if from [here](https://github.com/vercel/next.js/discussions/64993), to configure the
middleware such that it ignores server functions. I do auth checks in server functions though.

### Hydration Mismatch Errors, Fixing Initial Render Flicker

Sometimes in Next.js you may encounter hydration mismatch errors. Before we
understand what these errors are, let's first briefly review what
hydration means.

In a Next.js app, when you visit a page which uses server side rendering
(SSR), that page is pre-rendered on the server and the resulting HTML is
sent to the client. This HTML contains the content and structure of the
page but without the JavaScript logic that makes it interactive. The
reason this is done is to give the user something meaningful to look at
as quickly as possible. Once this initial HTML arrives in the browser,
Next.js runs JavaScript on the client to make the page fully interactive
— a process called hydration.

A hydration mismatch error happens when the HTML rendered on the server doesn’t
match what React renders on the client in memory during hydration.

You can get such error if your rendering process is based on information that is
only available on the client side (for example local storage); but there can
also be other reasons. During SSR such information is not available,
hence the render output you get during SSR may be different from the render output you get on the client.

One solution to fix such error is to skip SSR for the component entirely:

```
import { useState, useEffect } from 'react'

export default function SampleComponent() {
   const [isClient, setIsClient] = useState(false)

   useEffect(() => {
     setIsClient(true)
   }, [])

   if(!isClient) return null;

   return <h1>Hello World</h1>
}

```

This works because `useEffect` only runs on the client. On the server,
`isClient` is `false`, so the component returns `null` and effectively
no HTML is generated. While this approach often resolves hydration
errors, it also disables SSR for the component and all of its children.
That trade-off can be problematic for components which have many
children or content important for SEO.

#### My Case: Sidebar State

In my case I have sidebar state which I store in local storage and need it in some
components such as the
[`(main)/layout.tsx`](<https://github.com/gmoniava/movie-app/blob/main/src/app/(main)/layout.tsx>).
If I tried reading this value from local storage directly in the
`useState` initializer function in my layout file, it would cause hydration error.
I would also not be able to fix this using above fix (which skips SSR)
because it would opt out children of layout from SSR too, which is
basically my whole app. Besides I am not sure if reading local storage
in `useState` initializer function is ok since this function has to be pure.

So I decided to use another approach, which was to read the value of the
sidebar from local storage in `useEffect` instead of `useState` initializer
function and then store it in state variable.
This does not cause hydration error because `useEffect` runs _after_ hydration. You would also have to ensure that
the initial value of this state variable was the same both in client and server environments.
However, this approach had another problem, it caused a brief "flicker" on the initial render as the sidebar
state updated when switching say from closed to open after `useEffect` was run.

Finally, I ended up with a solution, which had neither the flicker
problem nor hydration error. I added an inline script that runs before
React hydrates, immediately applying the correct sidebar state to the
DOM - now the user doesn’t see the flicker. And also there is no
hydration error because I made sure there was no difference between the
DOM built from the server HTML (even after inline script is run) and
what was rendered during hydration. The solution is in the [`(main)/layout.tsx`](<https://github.com/gmoniava/movie-app/blob/main/src/app/(main)/layout.tsx>) file
and is based on this
[post](https://ethanniser.dev/blog/a-clock-that-doesnt-snap).

## Source Code

You can find the source code [here](https://github.com/gmoniava/movie-app).
